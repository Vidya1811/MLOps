# ---- Builder stage (build wheels) ----
FROM python:3.10-slim AS builder
WORKDIR /wheels

COPY src/requirements.txt .
RUN pip wheel --no-cache-dir --wheel-dir /wheels -r requirements.txt

# ---- Runtime stage ----
FROM python:3.10-slim
WORKDIR /app

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

RUN useradd -m appuser

# Copy wheels from builder and install ONLY wheel files
COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/*.whl && rm -rf /wheels

# Copy app code
COPY src/ /app/

# Create artifacts dir and grant permissions
RUN mkdir -p /app/artifacts && chown -R appuser:appuser /app

USER appuser
ENTRYPOINT ["python", "main.py"]
CMD ["--output-dir", "artifacts"]